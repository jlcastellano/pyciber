<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SESIÓN 3: Archivos, Expresiones Regulares y OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div>SESIÓN 3: Archivos, Expresiones Regulares y OS</div>
    </header>

    <section class="contenido-didactico">
        <h1>BLOQUE 1: Manejo de Archivos</h1>
   
        <h2>Parser de Logs de Acceso</h2>

        <pre><code class="language-python">#!/usr/bin/env python3
"""
Práctica: Parser de logs de autenticación (auth.log simulado)
"""

from datetime import datetime
from collections import Counter
import json

# Crear archivo de log simulado
logs_auth = """Jan 15 10:00:01 servidor sshd[1234]: Accepted password for admin from 192.168.1.100 port 52341 ssh2
Jan 15 10:00:15 servidor sshd[1235]: Failed password for root from 10.0.0.50 port 43210 ssh2
Jan 15 10:00:16 servidor sshd[1235]: Failed password for root from 10.0.0.50 port 43210 ssh2
Jan 15 10:00:17 servidor sshd[1235]: Failed password for root from 10.0.0.50 port 43210 ssh2
Jan 15 10:00:18 servidor sshd[1235]: Failed password for root from 10.0.0.50 port 43210 ssh2
Jan 15 10:00:19 servidor sshd[1235]: Failed password for root from 10.0.0.50 port 43210 ssh2
Jan 15 10:01:00 servidor sshd[1236]: Accepted publickey for developer from 192.168.1.50 port 33421 ssh2
Jan 15 10:02:30 servidor sshd[1237]: Failed password for invalid user test from 203.0.113.100 port 12345 ssh2
Jan 15 10:02:31 servidor sshd[1237]: Failed password for invalid user admin from 203.0.113.100 port 12346 ssh2
Jan 15 10:02:32 servidor sshd[1237]: Failed password for invalid user guest from 203.0.113.100 port 12347 ssh2
Jan 15 10:05:00 servidor sshd[1238]: Accepted password for backup from 192.168.1.200 port 45678 ssh2
Jan 15 10:10:00 servidor sudo[1240]: admin : TTY=pts/0 ; PWD=/home/admin ; USER=root ; COMMAND=/bin/cat /etc/shadow
Jan 15 10:15:00 servidor sshd[1241]: Failed password for root from 10.0.0.50 port 43220 ssh2
Jan 15 10:15:01 servidor sshd[1241]: Failed password for root from 10.0.0.50 port 43220 ssh2
Jan 15 10:20:00 servidor sshd[1242]: Accepted password for webmaster from 192.168.1.75 port 54321 ssh2"""

# Guardar log simulado
with open("auth.log", "w") as f:
    f.write(logs_auth)


def parsear_log_ssh(linea):
    """
    Parsea una línea de log SSH y extrae información relevante.
    
    Returns:
        dict o None si no es una línea de SSH
    """
    if "sshd" not in linea:
        return None
    
    resultado = {
        "timestamp": None,
        "tipo": None,
        "usuario": None,
        "ip": None,
        "puerto": None,
        "metodo": None
    }
    
    # Extraer timestamp (formato simplificado)
    partes = linea.split()
    if len(partes) >= 3:
        resultado["timestamp"] = f"{partes[0]} {partes[1]} {partes[2]}"
    
    # Determinar tipo de evento
    if "Accepted" in linea:
        resultado["tipo"] = "exitoso"
        
        # Extraer método de autenticación
        if "password" in linea:
            resultado["metodo"] = "password"
        elif "publickey" in linea:
            resultado["metodo"] = "publickey"
        
        # Extraer usuario e IP
        try:
            if "for" in linea and "from" in linea:
                idx_for = linea.index("for") + 4
                idx_from = linea.index("from")
                resultado["usuario"] = linea[idx_for:idx_from].strip()
                
                # Extraer IP y puerto
                resto = linea[idx_from + 5:].split()
                resultado["ip"] = resto[0]
                if "port" in linea:
                    idx_port = resto.index("port")
                    resultado["puerto"] = int(resto[idx_port + 1])
        except (ValueError, IndexError):
            pass
            
    elif "Failed" in linea:
        resultado["tipo"] = "fallido"
        resultado["metodo"] = "password"
        
        # Verificar si es usuario inválido
        if "invalid user" in linea:
            resultado["usuario_invalido"] = True
            try:
                idx = linea.index("invalid user") + 13
                resto = linea[idx:].split()
                resultado["usuario"] = resto[0]
                idx_from = resto.index("from")
                resultado["ip"] = resto[idx_from + 1]
            except (ValueError, IndexError):
                pass
        else:
            resultado["usuario_invalido"] = False
            try:
                idx_for = linea.index("for") + 4
                idx_from = linea.index("from")
                resultado["usuario"] = linea[idx_for:idx_from].strip()
                resto = linea[idx_from + 5:].split()
                resultado["ip"] = resto[0]
            except (ValueError, IndexError):
                pass
    
    return resultado


def analizar_logs(ruta_archivo):
    """
    Analiza un archivo de logs y genera estadísticas.
    """
    estadisticas = {
        "total_eventos": 0,
        "logins_exitosos": 0,
        "logins_fallidos": 0,
        "ips_con_fallos": Counter(),
        "usuarios_atacados": Counter(),
        "usuarios_exitosos": [],
        "posibles_ataques": []
    }
    
    with open(ruta_archivo, "r") as f:
        for linea in f:
            resultado = parsear_log_ssh(linea.strip())
            
            if resultado is None:
                continue
            
            estadisticas["total_eventos"] += 1
            
            if resultado["tipo"] == "exitoso":
                estadisticas["logins_exitosos"] += 1
                estadisticas["usuarios_exitosos"].append({
                    "usuario": resultado["usuario"],
                    "ip": resultado["ip"],
                    "metodo": resultado["metodo"],
                    "timestamp": resultado["timestamp"]
                })
            
            elif resultado["tipo"] == "fallido":
                estadisticas["logins_fallidos"] += 1
                if resultado["ip"]:
                    estadisticas["ips_con_fallos"][resultado["ip"]] += 1
                if resultado["usuario"]:
                    estadisticas["usuarios_atacados"][resultado["usuario"]] += 1
    
    # Detectar posibles ataques de fuerza bruta (más de 3 fallos desde misma IP)
    for ip, count in estadisticas["ips_con_fallos"].items():
        if count >= 3:
            estadisticas["posibles_ataques"].append({
                "ip": ip,
                "intentos_fallidos": count,
                "tipo": "Posible fuerza bruta"
            })
    
    return estadisticas


def generar_informe(estadisticas, ruta_salida="informe_auth.json"):
    """
    Genera un informe en formato JSON.
    """
    # Convertir Counters a diccionarios para JSON
    informe = {
        "fecha_analisis": datetime.now().isoformat(),
        "resumen": {
            "total_eventos_ssh": estadisticas["total_eventos"],
            "logins_exitosos": estadisticas["logins_exitosos"],
            "logins_fallidos": estadisticas["logins_fallidos"],
            "tasa_exito": round(
                estadisticas["logins_exitosos"] / max(estadisticas["total_eventos"], 1) * 100, 2
            )
        },
        "logins_exitosos": estadisticas["usuarios_exitosos"],
        "top_ips_fallidas": dict(estadisticas["ips_con_fallos"].most_common(10)),
        "top_usuarios_atacados": dict(estadisticas["usuarios_atacados"].most_common(10)),
        "alertas": estadisticas["posibles_ataques"]
    }
    
    with open(ruta_salida, "w", encoding="utf-8") as f:
        json.dump(informe, f, indent=4, ensure_ascii=False)
    
    return informe


# ========================================
# EJECUTAR ANÁLISIS
# ========================================

print("=" * 60)
print("   ANALIZADOR DE LOGS DE AUTENTICACIÓN")
print("=" * 60)

# Analizar logs
stats = analizar_logs("auth.log")

# Mostrar resultados
print(f"\n[*] RESUMEN DE EVENTOS SSH:")
print(f"    Total eventos: {stats['total_eventos']}")
print(f"    Logins exitosos: {stats['logins_exitosos']}")
print(f"    Logins fallidos: {stats['logins_fallidos']}")

print(f"\n[*] TOP IPs CON INTENTOS FALLIDOS:")
for ip, count in stats["ips_con_fallos"].most_common(5):
    print(f"    {ip}: {count} intentos")

print(f"\n[*] USUARIOS MÁS ATACADOS:")
for usuario, count in stats["usuarios_atacados"].most_common(5):
    print(f"    {usuario}: {count} intentos")

print(f"\n[*] LOGINS EXITOSOS:")
for login in stats["usuarios_exitosos"]:
    print(f"    {login['usuario']} desde {login['ip']} ({login['metodo']})")

if stats["posibles_ataques"]:
    print(f"\n[!] ALERTAS DE SEGURIDAD:")
    for alerta in stats["posibles_ataques"]:
        print(f"    ⚠ {alerta['tipo']}: {alerta['ip']} ({alerta['intentos_fallidos']} intentos)")

# Generar informe JSON
informe = generar_informe(stats)
print(f"\n[+] Informe generado: informe_auth.json")

print("\n" + "=" * 60)</code></pre>

    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="script.js"></script>
</body>
</html>